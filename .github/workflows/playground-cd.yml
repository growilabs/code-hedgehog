name: CD - Code Hedgehog Playground

on:
  push:
    branches:
      - '**' # Trigger on all branches
    paths:
      - 'packages/playground/**'
      - '.github/workflows/playground-cd.yml'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
      primary_tag: ${{ steps.extract-tag.outputs.primary_tag }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/growilabs/code-hedgehog
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short
            type=ref,event=branch
          labels: |
            org.opencontainers.image.title=Code Hedgehog Playground
            org.opencontainers.image.description=Code Hedgehog Playground Application
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./packages/playground
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract primary tag for deployment
        id: extract-tag
        run: |
          # „É°„Çø„Éá„Éº„Çø„Åã„ÇâÁîüÊàê„Åï„Çå„Åü„Çø„Ç∞„ÇíÂèñÂæó
          TAGS="${{ steps.meta.outputs.tags }}"
          echo "Generated tags:"
          echo "$TAGS"
          
          # ÊúÄÂàù„ÅÆ„Çø„Ç∞„Çí‰∏ªË¶Å„Çø„Ç∞„Å®„Åó„Å¶‰ΩøÁî®
          PRIMARY_TAG=$(echo "$TAGS" | head -n1)
          echo "Primary tag selected: $PRIMARY_TAG"
          
          # GitHub Actions„ÅÆÂá∫Âäõ„Å®„Åó„Å¶Ë®≠ÂÆö
          echo "primary_tag=$PRIMARY_TAG" >> $GITHUB_OUTPUT
          
          # Áü≠Á∏ÆSHA„Çø„Ç∞„ÇíÊòéÁ§∫ÁöÑ„Å´ÁîüÊàêÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          SHA_TAG="ghcr.io/growilabs/code-hedgehog:sha-${SHORT_SHA}"
          echo "SHA tag: $SHA_TAG"
          echo "sha_tag=$SHA_TAG" >> $GITHUB_OUTPUT

  # Kubernetes„Éá„Éó„É≠„Ç§„Ç∏„Éß„ÉñÔºà„ÉÜ„Çπ„ÉàÁî®ÔºöÂÖ®„Éñ„É©„É≥„ÉÅ„ÅßÂÆüË°åÔºâ
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    # if: github.ref == 'refs/heads/main'  # „ÉÜ„Çπ„ÉàÁî®„Å´„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà
    permissions:
      contents: read
    
    steps:
      - name: Show deployment info
        run: |
          echo "üîç Deployment Information"
          echo "========================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "üè∑Ô∏è Image Information"
          echo "===================="
          echo "Available tags:"
          echo "${{ needs.build-and-push.outputs.image_tags }}"
          echo ""
          echo "Primary tag: ${{ needs.build-and-push.outputs.primary_tag }}"
          echo "Digest: ${{ needs.build-and-push.outputs.image_digest }}"
          
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
      - name: Test cluster connection
        run: |
          echo "üîç Testing cluster connection..."
          kubectl cluster-info
          echo "‚úÖ Cluster connection successful"
          
          echo ""
          echo "üîç Checking namespaces..."
          kubectl get namespaces
          
          echo ""
          echo "üîç Checking code-hedgehog namespace..."
          if kubectl get ns code-hedgehog >/dev/null 2>&1; then
            echo "‚úÖ code-hedgehog namespace exists"
          else
            echo "‚ùå Namespace code-hedgehog does not exist"
            echo "Creating namespace..."
            kubectl create namespace code-hedgehog
          fi
          
      - name: Create or update image pull secret
        run: |
          echo "üîê Managing image pull secrets..."
          
          # Êó¢Â≠ò„ÅÆSecret„ÇíÂâäÈô§Ôºà„Ç®„É©„Éº„ÇíÁÑ°Ë¶ñÔºâ
          kubectl delete secret ghcr-secret -n code-hedgehog --ignore-not-found=true
          
          # Êñ∞„Åó„ÅÑSecret„Çí‰ΩúÊàê
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=code-hedgehog
            
          echo "‚úÖ Image pull secret created successfully"
          
      - name: Check existing deployment
        run: |
          echo "üîç Checking for existing deployment..."
          if kubectl get deployment code-hedgehog -n code-hedgehog >/dev/null 2>&1; then
            echo "‚úÖ Deployment 'code-hedgehog' exists"
            echo ""
            echo "Current deployment details:"
            kubectl get deployment code-hedgehog -n code-hedgehog -o wide
            echo ""
            echo "Current image:"
            kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.spec.template.spec.containers[0].image}'
            echo ""
          else
            echo "‚ùå Deployment 'code-hedgehog' does not exist"
            echo ""
            echo "Available deployments in code-hedgehog namespace:"
            kubectl get deployments -n code-hedgehog || echo "No deployments found"
          fi
          
      - name: Update deployment image
        run: |
          if kubectl get deployment code-hedgehog -n code-hedgehog >/dev/null 2>&1; then
            echo "üöÄ Updating deployment image..."
            
            # build-and-push„Ç∏„Éß„Éñ„Åã„Çâ„ÅÆ‰∏ªË¶Å„Çø„Ç∞„Çí‰ΩøÁî®
            NEW_IMAGE="${{ needs.build-and-push.outputs.primary_tag }}"
            
            echo "Current image:"
            CURRENT_IMAGE=$(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.spec.template.spec.containers[0].image}')
            echo "$CURRENT_IMAGE"
            echo ""
            echo "New image: $NEW_IMAGE"
            
            # imagePullSecrets„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
            PULL_SECRETS=$(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.spec.template.spec.imagePullSecrets[*].name}' 2>/dev/null || echo "")
            
            if [[ "$PULL_SECRETS" != *"ghcr-secret"* ]]; then
              echo "üîê Adding imagePullSecrets to deployment..."
              kubectl patch deployment code-hedgehog -n code-hedgehog \
                -p '{"spec":{"template":{"spec":{"imagePullSecrets":[{"name":"ghcr-secret"}]}}}}'
              echo "‚úÖ imagePullSecrets added"
            else
              echo "‚úÖ imagePullSecrets already configured"
            fi
            
            # „Ç§„É°„Éº„Ç∏„ÇíÊõ¥Êñ∞
            echo "üîÑ Updating container image..."
            kubectl set image deployment/code-hedgehog \
              code-hedgehog="$NEW_IMAGE" \
              -n code-hedgehog
              
            echo "‚úÖ Image update command executed successfully"
            
            # Êõ¥Êñ∞Âæå„ÅÆ„Ç§„É°„Éº„Ç∏„ÇíÁ¢∫Ë™ç
            echo ""
            echo "Updated image:"
            kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.spec.template.spec.containers[0].image}'
            echo ""
            
          else
            echo "‚ö†Ô∏è Deployment does not exist, skipping image update"
            echo "Please create the deployment first using the manifest file"
            exit 1
          fi
            
      - name: Wait for rollout completion
        run: |
          if kubectl get deployment code-hedgehog -n code-hedgehog >/dev/null 2>&1; then
            echo "‚è≥ Waiting for rollout to complete..."
            
            # „É≠„Éº„É´„Ç¢„Ç¶„Éà„ÅÆÁä∂ÊÖã„ÇíÁõ£Ë¶ñ
            if kubectl rollout status deployment/code-hedgehog \
              -n code-hedgehog --timeout=300s; then
              echo "‚úÖ Rollout completed successfully"
            else
              echo "‚ùå Rollout failed or timed out"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Skipping rollout verification (deployment does not exist)"
          fi
            
      - name: Verify deployment health
        run: |
          echo "üè• Verifying deployment health..."
          
          # „Éá„Éó„É≠„Ç§„É°„É≥„Éà„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç
          echo "Deployment status:"
          kubectl get deployment code-hedgehog -n code-hedgehog -o wide
          echo ""
          
          # Pod„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç
          echo "Pod status:"
          kubectl get pods -n code-hedgehog -l app=code-hedgehog -o wide
          echo ""
          
          # ReplicaSet„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç
          echo "ReplicaSet status:"
          kubectl get rs -n code-hedgehog -l app=code-hedgehog
          echo ""
          
          # ÊúÄÊñ∞„ÅÆ„Ç§„É°„Éº„Ç∏„Åå‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
          DEPLOYED_IMAGE=$(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.spec.template.spec.containers[0].image}')
          EXPECTED_IMAGE="${{ needs.build-and-push.outputs.primary_tag }}"
          
          echo "Image verification:"
          echo "Expected: $EXPECTED_IMAGE"
          echo "Deployed: $DEPLOYED_IMAGE"
          
          if [ "$DEPLOYED_IMAGE" = "$EXPECTED_IMAGE" ]; then
            echo "‚úÖ Image verification successful"
          else
            echo "‚ùå Image mismatch detected"
            exit 1
          fi
          
      - name: Get deployment status and logs
        if: always()
        run: |
          echo "üìä Final deployment status..."
          echo "============================="
          
          # ÂêçÂâçÁ©∫ÈñìÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆ„É™„ÇΩ„Éº„Çπ
          echo "All resources in code-hedgehog namespace:"
          kubectl get all -n code-hedgehog
          echo ""
          
          # „Éá„Éó„É≠„Ç§„É°„É≥„Éà„ÅÆË©≥Á¥∞
          if kubectl get deployment code-hedgehog -n code-hedgehog >/dev/null 2>&1; then
            echo "Deployment details:"
            kubectl describe deployment code-hedgehog -n code-hedgehog
            echo ""
          fi
          
          # Pod „ÅÆË©≥Á¥∞„Å®„É≠„Ç∞
          echo "Pod details and logs:"
          for pod in $(kubectl get pods -n code-hedgehog -l app=code-hedgehog -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "=== Pod: $pod ==="
            kubectl describe pod $pod -n code-hedgehog
            echo ""
            echo "Recent logs:"
            kubectl logs $pod -n code-hedgehog --tail=20 || echo "Could not retrieve logs"
            echo ""
          done
          
          # ÊúÄËøë„ÅÆ„Ç§„Éô„É≥„Éà
          echo "Recent events in code-hedgehog namespace:"
          kubectl get events -n code-hedgehog --sort-by='.lastTimestamp' | tail -10
          
      - name: Deployment summary
        if: always()
        run: |
          echo "üìã Deployment Summary"
          echo "===================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Image: ${{ needs.build-and-push.outputs.primary_tag }}"
          echo "Namespace: code-hedgehog"
          echo "Deployment Status: $(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.status.conditions[?(@.type=="Available")].status}' 2>/dev/null || echo "Unknown")"
          echo "Ready Replicas: $(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")/$(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "Unknown")"
          
          # „Éá„Éó„É≠„Ç§„É°„É≥„Éà„ÅåÊàêÂäü„Åó„Åü„Åã„ÅÆÊúÄÁµÇÁ¢∫Ë™ç
          if kubectl get deployment code-hedgehog -n code-hedgehog >/dev/null 2>&1; then
            READY_REPLICAS=$(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
            DESIRED_REPLICAS=$(kubectl get deployment code-hedgehog -n code-hedgehog -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0")
            
            if [ "$READY_REPLICAS" = "$DESIRED_REPLICAS" ] && [ "$READY_REPLICAS" != "0" ]; then
              echo "üéâ Deployment completed successfully!"
            else
              echo "‚ö†Ô∏è Deployment may not be fully ready"
            fi
          else
            echo "‚ùå Deployment not found"
          fi