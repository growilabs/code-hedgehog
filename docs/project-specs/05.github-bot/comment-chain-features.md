# GitHub Bot: コメント関連機能 (履歴、スレッド、状態、インタラクション)

## 1. 目的

GitHub Bot は、プルリクエスト上のレビューコメントとその関連情報を効果的に管理・活用することで、以下の目的を達成します。

-   **文脈の維持:** 過去のコメント履歴を AI プロセッサに提供し、文脈を踏まえたレビューやインタラクション応答を可能にする。
-   **議論の追跡:** GitHub のコメントスレッド機能を活用し、特定の指摘事項に関する議論の流れを分かりやすく整理する。
-   **進捗の可視化:** GitHub の "Resolve conversation" 機能と連携し、指摘事項の解決状況を追跡・表示する (Checks API 経由)。
-   **対話的な改善:** ユーザーが Bot の指摘に対して質問したり指示を出したりできるインタラクティブな機能を提供する。

## 2. 実現アプローチ: GitHub 標準機能の活用

CodeRabbit のような独自の状態管理システムを構築する代わりに、本 GitHub Bot は以下の GitHub 標準機能を最大限に活用して上記目的を実現します。

-   **コメントスレッド (Replies):** 指摘事項とその後の議論 (ユーザーからの質問、Bot からの応答など) をスレッド形式で管理します。
-   **Resolve Conversation:** 指摘事項の解決状態を管理します。ユーザーはこの機能を使って指摘を解決済みにできます。
-   **Checks API:** レビュープロセス全体の実行状況や、未解決の指摘数を表示するためのインターフェースとして利用します。
-   **GitHub Actions (`issue_comment` トリガー):** ユーザーからのコメント (特に `@bot` メンション) を検知し、インタラクションを開始します。

## 3. 主要機能詳細

### 3.1. コメント履歴の収集と活用

-   **収集:** PR イベント (`pull_request`, `issue_comment`) をトリガーとして、GitHub API を使用し、関連する既存のレビューコメント (特に Bot が投稿したものや、インタラクションの対象となるコメント) を取得します。
-   **整形:** 取得したコメント情報を、プロセッサが解釈可能な形式 (`CommentInfo[]` など) に整形します。これには、コメント ID, 本文, 投稿者, 投稿日時, 関連ファイルパス, 行番号, スレッドの親子関係などの情報が含まれる可能性があります。
-   **活用:** 整形されたコメント履歴を、プロセッサの入力 (`ProcessInput.commentHistory`, `InteractionInput.commentHistory`) として渡します。これにより、プロセッサは過去の議論や指摘を踏まえたレビューや応答生成が可能になります。

### 3.2. コメント投稿とスレッド活用

-   **新規指摘:** プロセッサから返された新しい指摘 (`ProcessOutput.comments`) は、GitHub API を使用して PR 上の該当コード行に対する**新しいレビューコメント**として投稿されます。
-   **応答・追加コメント:**
    -   インタラクション機能 (`@bot`) に対する Bot からの応答 (`InteractionOutput.replyBody`) は、ユーザーがメンションした元のコメントに対する**返信 (Reply)** として投稿されます。
    -   (将来的な機能) 既存の指摘に対する追加情報や修正提案なども、元の指摘コメントへの返信として投稿される可能性があります。
-   **利点:** GitHub の標準的なスレッド UI を利用することで、ユーザーは自然な形で議論を追跡できます。

### 3.3. 指摘解決追跡 (Resolve Conversation 連携)

-   **トリガー:** GitHub の "Resolve conversation" 機能によるスレッド状態の変更を検知します。
    -   **Webhook (推奨):** GitHub App として `pull_request_review_thread.resolved` / `unresolved` イベントを購読します (別インフラが必要な可能性あり)。
    -   **API ポーリング (代替案):** 定期実行 Action (`schedule`, `workflow_run`) で API をポーリングします。
-   **状態把握:** レビュー完了時および状態変更検知時に、GitHub API で PR 上のレビューコメントスレッドを取得し、Bot が起点となっている**未解決 (unresolved) のスレッド数**をカウントします。
-   **フィードバック (Checks API 更新):** カウントした未解決数を、関連する Check Run の `output.summary` に反映させます (例: "Code Review: 3 unresolved issues remaining.")。すべての指摘が解決された場合は、その旨をサマリーに表示します (例: "✨ All suggestions resolved!")。
-   **Conclusion 制御 (オプション):** 設定ファイル (`.codehedgehog/review.yaml` の `checks.fail_on_unresolved_issues`) により、未解決の指摘がある場合に Check Run の `conclusion` を `failure` に設定することも可能です。

### 3.4. インタラクティブ機能 (`@bot`)

-   **トリガー:** ユーザーが PR 上のコメントで Bot (`@bot`) をメンションし、指示 (例: `@bot この指摘を詳しく説明して`) を投稿します。
-   **処理フロー:**
    1.  `issue_comment` トリガーで専用の GitHub Action が起動します。
    2.  Action Runner はコメント内容を解析し、指示内容 (`userInstruction`) と対象コメント (`targetComment`) を特定します。
    3.  関連コンテキスト (PR情報, コード差分, コメント履歴など) を収集し、`InteractionInput` を作成します。
    4.  `InteractionInput` をプロセッサの `handleInteraction` メソッドに渡します。
    5.  プロセッサは指示を解釈し、応答 (`InteractionOutput.replyBody`) を生成します。
    6.  Action Runner は、生成された応答を元のコメントへの**返信**として投稿します。
-   **目的:** レビュープロセスをより対話的にし、ユーザーが Bot の指摘を理解し、改善を進めやすくします。

## 4. まとめ

GitHub Bot は、GitHub の標準機能を活用することで、コメント履歴の文脈維持、議論のスレッド化、指摘の状態追跡、そしてユーザーとの対話を実現します。これにより、開発者は使い慣れたインターフェース上で、より効果的な AI コードレビュー体験を得ることができます。