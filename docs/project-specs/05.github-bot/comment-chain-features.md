# Processor: コメント関連機能の活用

## 1. 目的

このドキュメントは、Code Hedgehog の **Processor** (コアレビューシステム) が、GitHub Bot Runner (以下、Runner) から提供される**コメント履歴**や**インタラクション情報**をどのように解釈し、活用するかについての仕様を定義します。これにより、Processor は過去の議論の文脈を踏まえ、より的確で一貫性のあるレビューコメントや、ユーザーの指示に応じた適切な応答を生成することを目指します。

## 2. 前提: Runner からの情報提供

Processor がコメント関連機能を効果的に活用するためには、Runner から以下の情報が適切に提供されることが前提となります。

-   **コメント履歴 (`ProcessInput.commentHistory`, `InteractionInput.relatedComments`):**
    -   Runner は、レビュー対象のプルリクエストに関連する既存のコメント (レビューコメント、PRコメント) を収集し、`CommentInfo` オブジェクトの配列として Processor に渡します。
    -   `CommentInfo` には、コメント ID, 本文, 投稿者, 投稿日時, 関連ファイルパス, 行番号, スレッドの親子関係 (`in_reply_to_id`) などが含まれます。
-   **インタラクション情報 (`InteractionInput`):**
    -   ユーザーが `@bot` をメンションした場合、Runner はそのコメントを解析し、ユーザーの指示内容 (`userInstruction`) と、指示の対象となっている元のコメント情報 (`targetComment`) を特定して Processor に渡します。
    -   インタラクションに必要なその他のコンテキスト (PR情報, コード差分, 関連コメント履歴など) も `InteractionInput` に含まれます。

## 3. コメント履歴の解釈と活用 (Processor の責務)

Processor は、Runner から受け取ったコメント履歴 (`CommentInfo[]`) を分析し、レビューや応答生成の品質向上に役立てます。

-   **3.1. 文脈理解:**
    -   **議論の流れの把握:** 特定のコード箇所やファイルに対して、過去にどのような指摘や議論が行われたかを理解します。
    -   **重複指摘の回避:** 過去に同様の指摘がされていないかを確認します。
    -   **スレッド追跡:** `in_reply_to_id` を辿ることで、特定の指摘に対する一連のやり取り (ユーザーの質問、以前の Bot の応答など) を把握します。
-   **3.2. レビュー品質の向上:**
    -   **一貫性の確保:** 以前の指摘や議論と矛盾しないレビューコメントを生成します。
    -   **フォローアップ:** 以前の指摘が修正されているか、あるいは別の問題を引き起こしていないかを確認します。
    -   **ユーザー意図の考慮:** コメント履歴からユーザーの懸念点や質問を推測し、レビューコメントでそれらに対応することを目指します。
-   **3.3. 実装方針:**
    -   **プロンプトへの組み込み:** コメント履歴の情報を、レビュー生成や応答生成のためのプロンプトに効果的に組み込みます。例えば、関連する過去のコメントを抜粋してコンテキストとして提供します。
    -   **高度な活用 (オプション):** 大量のコメント履歴を扱う場合、コメント本文をベクトル化し、類似コメント検索を行うことで、関連性の高い過去の議論を効率的に特定するアプローチも考えられます。

## 4. インタラクション応答生成 (Processor の責務)

Processor は、Runner から受け取った `InteractionInput` を解釈し、ユーザーの指示に応じた応答 (`InteractionOutput.reply`) を生成します。

-   **4.1. 指示 (`userInstruction`) の解釈:**
    -   ユーザーが `@bot` に続けて入力したテキスト (例: "explain this further", "suggest an alternative", "ignore this") を解析し、意図を理解します。自然言語処理 (NLP) 技術や単純なキーワードマッチングなどが考えられます。
-   **4.2. 対象コメント (`targetComment`) と関連コンテキストの分析:**
    -   ユーザーがどの指摘コメントに対して指示を出しているか (`targetComment`) を正確に把握します。
    -   その指摘の内容、関連するコード差分、周辺のコメント履歴などを分析し、応答生成に必要な情報を収集します。
-   **4.3. 応答 (`InteractionOutput.reply`) の生成:**
    -   **応答ロジック:** 解釈された指示内容に基づき、適切な応答を生成します。
        -   `explain`: 指摘の根拠や背景をより詳しく説明する。
        -   `suggest`: 具体的な修正コード案を提示する。
        -   `ignore`: 指摘を無視する（あるいは無視を確認する応答を返す）。
        -   その他、定義されたコマンドに応じた処理。
    -   **応答フォーマット:** 生成される応答メッセージは、Markdown 形式など、GitHub 上で読みやすい形式であるべきです。

## 5. Processor 実装例における考慮事項

各 Processor (例: `OpenaiProcessor`, `DifyProcessor`) は、上記の方針に基づき、それぞれの特性 (利用する AI モデル、プロンプトエンジニアリング技術など) に合わせてコメント履歴の活用方法やインタラクション応答の生成ロジックを実装する必要があります。例えば、OpenAI Processor であれば、プロンプトにコメント履歴の要約や関連部分を含める工夫が考えられます。