# パスベース設定システム仕様

## 概要

パスベース設定システムは、ファイルパスパターンに基づいてレビュー方針やルールを定義する機能を提供します。このシステムにより、ファイルの種類や場所に応じて適切なレビュー指示を設定できます。

## Glob パターンについて

本設定ファイルでは、ブランチ名やファイルパスを指定する際に Glob パターンを使用します。これは Unix シェルのようなワイルドカードを用いたパターンマッチング記法です。

-   **実装:** [minimatch](https://github.com/isaacs/minimatch) ライブラリの仕様に準拠します。
-   **主な記号:**
    -   `*`: スラッシュ (`/`) を除く任意の0文字以上の文字列にマッチします。
    -   `**`: 任意の0文字以上の文字列 (ディレクトリ階層を含む) にマッチします。
    -   `?`: スラッシュ (`/`) を除く任意の1文字にマッチします。
    -   `{alt1,alt2}`: `alt1` または `alt2` のいずれかにマッチします。
-   **パス:** パターンはプロジェクトルートからの相対パスとして解釈されます。

## 設定ファイル

### 基本構造

設定ファイルは `.coderabbitai.yaml` という名前でプロジェクトのルートディレクトリに配置します。

```yaml
# LLM のレスポンスの言語
# ISO 言語コードを指定する、デフォルトは "ja-JP"
language: "ja-JP"

# PRレベルの制御
ignore_draft_prs: true # ドラフトPRを無視するか (デフォルト: true)
ignored_branches: # レビュー対象外のブランチ (Globパターン)
  - "dev/*"
  - "release"
ignored_titles: # レビュー対象外のPRタイトルに含まれる文字列
  - "WIP"
  - "DO NOT MERGE"
limit_reviews_by_labels: # レビュー対象を特定のラベルを持つPRに限定 (空の場合は制限なし)
  - "needs-review"

# ファイルレベルの制御
skip_simple_changes: true # シンプルな変更をスキップするか (デフォルト: false)
review_diff_since_last_review: false # 最後の AI レビュー以降の差分のみをレビュー対象とするか (デフォルト: false)
# ファイルフィルター設定
# path_filters は非推奨です。file_filter.exclude を使用してください。
# file_filter と path_filters が両方指定された場合、file_filter.exclude が優先されます。
# 将来的には path_filters のサポートは削除されます。
file_filter:
  exclude: # レビュー対象外のファイルパス (Globパターン, 除外専用)
    - "dist/**"
    - "**/*.min.js"
    - "**/*.map"
    - "deno.lock"
    - "yarn.lock"
  max_changes: 300 # レビュー対象とするファイルの最大変更行数 (0の場合は無制限, デフォルト: 0)
file_path_instructions: # パスごとのレビュー指示
  - path: "src/**/*.{ts,tsx}"
    instructions: |
      TypeScriptコードのレビュー指示：
      - 型の適切な使用
      - nullチェックの完全性
      - 非同期処理の適切な実装
  - path: "test/**/*.ts"
    instructions: |
      テストコードのレビュー指示：
      - テストケースの網羅性
      - エッジケースの考慮
      - テストの独立性確保

# GitHub Checks API 連携設定
checks:
  fail_on_unresolved_issues: false # 未解決の指摘がある場合に Check Run を failure にするか (デフォルト: false)
```

## 設定項目

### language

-   レビューに使用する言語コード (例: `"ja-JP"`, `"en-US"`)。
-   型: `string`
-   デフォルト: `"ja-JP"`

### ignore_draft_prs

-   `true` の場合、ドラフト状態のプルリクエストをレビュー対象外とします。
-   型: `boolean`
-   デフォルト: `true`
-   **(注意: この設定項目は仕様として定義されていますが、現状の `.coderabbitai.yaml` の読み込み処理では解釈されず、実際のPRフィルタリングロジックにも適用されていません)**

### ignored_branches

-   レビュー対象外とするブランチ名の Glob パターンリスト。
-   型: `string[]`
-   デフォルト: `[]`
-   **(注意: この設定項目は仕様として定義されていますが、現状の `.coderabbitai.yaml` の読み込み処理では解釈されず、実際のPRフィルタリングロジックにも適用されていません)**

### ignored_titles

-   レビュー対象外とするプルリクエストのタイトルに含まれる文字列リスト (大文字小文字を区別しない)。
-   型: `string[]`
-   デフォルト: `[]`
-   **(注意: この設定項目は仕様として定義されていますが、現状の `.coderabbitai.yaml` の読み込み処理では解釈されず、実際のPRフィルタリングロジックにも適用されていません)**

### limit_reviews_by_labels

-   レビュー対象を、ここに指定されたラベルのいずれかを持つプルリクエストに限定します。
-   空のリストの場合は、ラベルによる制限を行いません。
-   型: `string[]`
-   デフォルト: `[]`
-   **(注意: この設定項目は仕様として定義されていますが、現状の `.coderabbitai.yaml` の読み込み処理では解釈されず、実際のPRフィルタリングロジックにも適用されていません)**

### skip_simple_changes

-   `true` の場合、シンプルな変更 (フォーマット、コメント、空白行のみ) をレビュー対象外とします。
-   型: `boolean`
-   デフォルト: `false`

### review_diff_since_last_review

- `true` の場合、最後の AI レビュー以降に発生した差分のみをレビュー対象とします。
- これにより、過去にレビュー済みの部分を再度レビューすることを避け、効率的な差分レビューが可能になります。
- 型: `boolean`
- デフォルト: `false`

### file_filter

- ファイルのフィルタリングに関する設定をまとめたオブジェクト。

#### file_filter.exclude

-   レビュー対象から**除外**するファイルパスの Glob パターンリスト。
-   このリストは除外専用であり、包含パターン (`!` プレフィックスなど) は指定できません。指定されたパターンにマッチするファイルはレビュー対象外となります。
-   型: `string[]`
-   デフォルト:
    ```yaml
    - "dist/**"
    - "**/*.min.js"
    - "**/*.map"
    - "**/node_modules/**"
    - "**/vendor/**"
    - "deno.lock"
    - "yarn.lock"
    ```

#### file_filter.max_changes

- レビュー対象とするファイルの最大変更行数を指定します。この行数を超える変更があったファイルはレビュー対象外となります。
- `0` を指定した場合は無制限となります。
- 型: `number`
- デフォルト: `0` (無制限)

### file_path_instructions

-   ファイルパスパターンごとに適用するレビュー指示のリスト。
-   型: `Array<{ path: string; instructions: string }>`
-   `path`: [minimatch](https://github.com/isaacs/minimatch) 形式の Glob パターン。
-   `instructions`: マークダウン形式のレビュー指示。AI へのプロンプトに追加されます。
-   デフォルト: `[]`

### checks

**(注意: `checks` およびその配下の設定項目は仕様として定義されていますが、現状の `.coderabbitai.yaml` の読み込み処理では解釈されず、GitHub Checks API との連携機能も実装されていません)**

-   GitHub Checks API の挙動を制御する設定。

#### checks.fail_on_unresolved_issues

-   `true` に設定すると、Code Hedgehog Bot が投稿したレビューコメント (指摘) が1つでも未解決 (unresolved) の場合、関連する Check Run の `conclusion` を `failure` に設定します。
-   これにより、未解決の指摘がある場合に PR のマージをブロックするなどの連携が可能になります。
-   `false` の場合、未解決の指摘があっても Check Run の `conclusion` は `success` (またはエラーが発生した場合は `failure`) となり、指摘の解決状況は `conclusion` に影響しません。
-   型: `boolean`
-   デフォルト: `false`

## パターンマッチング

### マッチングの優先順位

1. より具体的なパターンが優先される
2. 設定ファイル内での順序が考慮される
3. 複数のパターンにマッチする場合、すべての指示が結合される

### パターンの制約

- 相対パスのみサポート
- プロジェクトルートからの参照
- ワイルドカード（`*`, `**`）使用可能
- 複数の拡張子は `{js,ts}` のように指定

## エラー処理

### 設定ファイルのエラー

1. **ファイルが存在しない場合**
   - デフォルト設定を使用
   - 警告ログを出力

2. **構文エラーの場合**
   - エラー内容を報告
   - デフォルト設定を使用

3. **無効なパターンの場合**
   - 該当パターンをスキップ
   - 警告ログを出力

## 使用例

### 1. 基本的な設定 (TypeScript プロジェクト)

```yaml
language: "ja-JP"
skip_simple_changes: true
file_filter:
  exclude:
    - "dist/**"
    - "**/*.map"
  max_changes: 500 # 例: 500行以上の変更があるファイルはスキップ
file_path_instructions:
  - path: "src/**/*.ts"
    instructions: |
      TypeScriptのベストプラクティスに従ってください。
      - any型を避ける
      - 未使用の変数やインポートがないか確認
  - path: "**/*.test.ts"
    instructions: |
      テストコードの品質を確認してください。
      - 十分なアサーションがあるか
      - モックが適切に使用されているか
```

### 2. PR レベルでの制御例

```yaml
# WIP の PR と dev ブランチへの PR はレビューしない
ignored_titles:
  - "WIP"
ignored_branches:
  - "dev/*"

# "ready-for-review" ラベルが付いた PR のみレビューする
limit_reviews_by_labels:
  - "ready-for-review"

# ドラフト PR はレビューしない (デフォルト)
ignore_draft_prs: true
```

### 3. 複数パスへの指示と除外

```yaml
file_filter:
  exclude:
    - "**/generated/**" # 生成されたコードを除外
    - "**/fixtures/**" # テストフィクスチャを除外
file_path_instructions:
  - path: "src/core/**/*.py"
    instructions: |
      コアロジックのレビュー：
      - パフォーマンスへの影響を考慮
      - エラーハンドリングの網羅性
  - path: "src/utils/**/*.py"
    instructions: "ユーティリティ関数のレビュー：再利用性とドキュメントを確認"
  - path: "**/*.py" # 上記以外の Python ファイルへの指示
    instructions: "Python の標準的なコーディング規約 (PEP8) を確認"
```

## 注意事項

1. **パターンの検証**
   - 設定読み込み時に構文チェック
   - 無効なパターンは警告付きでスキップ

2. **指示内容の制約**
   - マークダウン形式のみサポート
   - プレーンテキストとして解釈
   - 特殊な制御文字は無視

3. **パフォーマンス考慮**
   - パターンキャッシュの活用
   - 最適化されたマッチングアルゴリズム
   - 不要なファイルの早期スキップ
## 設定読み込みロジック (`loadConfig`)

設定ファイル (`.coderabbitai.yaml`) の読み込みは以下の手順で行われます。

1.  **デフォルト設定**: まず、システム定義のデフォルト設定 (`DEFAULT_CONFIG`) で初期化されます。
2.  **ファイルアクセス**: 設定ファイルの存在と読み取り権限を確認します。
    *   ファイルが存在しない、または読み取れない場合、警告ログを出力し、デフォルト設定を使用します。
3.  **読み込みとパース**: ファイル内容を読み込み、YAML としてパースします。
4.  **形式検証**: パース結果が有効なオブジェクト形式か検証します。
    *   無効な形式の場合、警告ログを出力し、デフォルト設定を使用します。
5.  **マージ**: パースされた設定をデフォルト設定にマージします。設定ファイルの値がデフォルト値を上書きします。
6.  **エラーハンドリング**: 上記以外のエラーが発生した場合 (例: 予期せぬ I/O エラー)、エラーログを出力し、デフォルト設定を使用します。

## パターンマッチングの詳細

### 具体性の計算 (`calculatePatternSpecificity`)

複数のパターンがファイルにマッチした場合の優先順位付けのため、各 glob パターンには「具体性スコア」が計算されます。スコアが高いほど具体的とみなされます。

スコアリングルール:

-   **基本スコア**: パターンの文字長。長いほど高スコア。
-   **減点**:
    -   `**` (ダブルワイルドカード): 1つにつき -3 点。
    -   `*` (シングルワイルドカード): 1つにつき -2 点。
-   **加点**:
    -   `.` (拡張子指定): +5 点。
    -   `{}` (拡張子グループ): +3 点。

### 指示の取得と結合 (`getInstructionsForFile`)

ファイルパスに適用されるレビュー指示は以下の手順で決定されます。

1.  **設定確認**: `file_path_instructions` が設定されているか確認します。なければ空文字列を返します。
2.  **パターンマッチング**: 設定内の各 `path` パターンがファイルパスにマッチするかを `matchesGlobPattern` で判定します。
3.  **具体性計算**: マッチした各パターンの具体性スコアを `calculatePatternSpecificity` で計算します。
4.  **ソート**: マッチした指示を以下の順でソートします。
    1.  具体性スコアが高い順 (降順)。
    2.  具体性が同じ場合は、設定ファイル内での元の記述順 (昇順)。
5.  **結合**: ソートされた指示の `instructions` 文字列を、改行2つ (`\n\n`) で結合して最終的な指示文字列を生成します。
6.  **エラーハンドリング**: 処理中にエラーが発生した場合、警告ログを出力し、空文字列を返します。

### Glob から正規表現への変換 (`matchesGlobPattern`)

`matchesGlobPattern` 関数は、glob パターンを正規表現に変換してマッチングを行います。

主な変換ルール:

-   `**` → `.*` (スラッシュを含む任意の0文字以上)
-   `*` → `[^/]*` (スラッシュを含まない任意の0文字以上)
-   `?` → `[^/]` (スラッシュを含まない任意の1文字)
-   `{alt1,alt2}` → `(?:alt1|alt2)` (選択肢)
-   その他の正規表現メタ文字はエスケープされます。
-   生成された正規表現は `^...$` で囲まれ、完全一致を要求します。

不正な glob パターン (例: `{` が閉じられていない) が指定された場合、警告ログが出力され、そのパターンはマッチしないものとして扱われます (`false` を返す)。