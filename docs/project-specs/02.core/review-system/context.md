# コンテキスト管理の仕様 (旧設計案)

**重要:** このドキュメントは、Code Hedgehog の初期設計段階で検討された、より複雑なコンテキスト管理システムに関する**古い仕様案**です。特に「3段階レビュープロセス」や「アスペクト」といった概念は、現在の GitHub Actions ベースの設計では採用されていません。

現在のコンテキスト収集・管理に関する仕様は、以下のドキュメントを参照してください。
-   [GitHub Bot 仕様](../../project-specs/05.github-bot/overview.md) (特にセクション 2.2 コンテキスト収集)
-   [GitHub Bot: コメント関連機能仕様](../../project-specs/05.github-bot/comment-chain-features.md)
-   [レビューコンテキスト管理仕様 (旧設計案)](./review-context.md) (よりシンプルな旧設計案)

---

## 1. 概要 (旧設計案)

(旧設計案) このドキュメントでは、以前検討されていた「3段階レビュープロセス」を支える、より高度なコンテキスト管理システムの仕様案を説明します。Bot 自身がレビューの文脈を深く理解・管理し、最適化することを目的としていました。

### 1.1 背景と意図 (旧設計案)

(旧設計案) コンテキスト管理システムは、以下の課題認識から設計されました：

1.  **部分的な理解の限界:** 個々の変更だけでなく、関連性や全体への影響を把握する必要性。
2.  **一貫性のある判断の必要性:** レビュー基準の一貫性維持と重複・矛盾の防止。
3.  **リソースの効率的な活用:** 変更の重要度に応じたリソース配分とインクリメンタル処理。

**現在の設計との関連:** これらの課題認識自体は現在の設計でも重要ですが、解決アプローチが異なります。現在の設計では、GitHub の機能を活用し、Bot 自身の状態管理をシンプルにすることで、効率性と保守性を両立しようとしています。

### 1.2 設計思想 (旧設計案)

(旧設計案) コンテキスト管理は、以下の原則に基づいて設計されていました：

1.  **階層化された理解:** PR全体、ファイル単位、変更単位の3層でのコンテキスト管理 (「アスペクト」などの概念を含む)。
2.  **インクリメンタルな処理:** 軽量な分析から開始し、必要に応じて詳細化。バッチ処理による効率化。
3.  **拡張可能なアーキテクチャ:** プロセッサによる独自コンテキスト管理、パスベース設定、外部連携。

**現在の設計との違い:** 現在の設計では、「階層化された理解」は主にプロセッサの責務となり、「アスペクト」のような Bot 共通の概念は持ちません。インクリメンタル処理は実装されていません。拡張性はプロセッサの選択・追加や Action ワークフローのカスタマイズで実現します。

## 2. コンテキストの階層構造 (旧設計案)

(旧設計案) 3つの階層でコンテキストを管理する想定でした。`[実装済み]` の記述は旧設計段階のものです。

### 2.1 PRレベルのコンテキスト (旧設計案)

(旧設計案) PR全体の情報を管理。`OverallSummary` や「アスペクト」(`aspectMappings`)、「マルチパス分析」といった概念は、現在の設計では採用されていません。

```typescript
// 旧設計案のインターフェース
interface IPullRequestInfo { /* ... */ }
interface OverallSummary { /* アスペクト情報などを含む */ }
```

**現在の設計:** `Action Runner` は PR の基本情報 (`IPullRequestInfo` に相当) を GitHub API から取得し、`ProcessInput` に含めます。PR 全体のサマリー (`ProcessOutput.summary`) は、レビュー後にプロセッサが生成します。

### 2.2 ファイルレベルのコンテキスト (旧設計案)

(旧設計案) 個々のファイルの変更を文脈化。「パス設定」(`PathInstruction`) は現在の設計でも `.coderabbitai.yaml` の `path_instructions` として存在します。「アスペクト管理」や `SummarizeResult` のような詳細な初期分析結果の管理は、現在の設計では行いません。「変更の分類」(`isSimpleChange`, `shouldPerformDetailedReview`) は、プロセッサ内部で判断される可能性がありますが、`BaseProcessor` の共通機能としては定義されていません。

```typescript
// 旧設計案のインターフェース
interface PathInstruction { /* ... */ }
interface SummarizeResult { /* アスペクト情報などを含む */ }
```

**現在の設計:** `Action Runner` はファイル差分情報 (`IFileChange[]`) を収集します。パスベースの設定 (`path_instructions`, `path_filters`) は `Action Runner` または `FileManager` で適用されます。ファイルごとの詳細な初期分析や分類は行わず、プロセッサに処理を委ねます。

### 2.3 変更レベルのコンテキスト (旧設計案)

(旧設計案) 個々の変更 (Hunk) レベルのコンテキスト。「レビューコメント管理」(`IReviewComment`) は、現在の設計では GitHub API から取得するコメント情報 (`CommentInfo`) に近いです。「トークン管理」(`TokenConfig`) は現在の設計でも重要であり、プロセッサや `Action Runner` で考慮されます。「重複防止」は、現在の設計ではプロセッサが `commentHistory` を参照して行います。

```typescript
// 旧設計案のインターフェース
interface IReviewComment { /* ... */ }
interface TokenConfig { /* ... */ }
```

**現在の設計:** `Action Runner` はコメント履歴 (`CommentInfo[]`) を収集します。トークン管理はプロセッサの責務です。重複防止もプロセッサが `commentHistory` を見て判断します。

## 3. コンテキスト処理フロー (旧設計案)

(旧設計案) 「3フェーズレビュー」(`summarize`, `generateOverallSummary`, `review`) は、現在の設計では採用されていません。

### 3.1 3フェーズレビュー (旧設計案)

(旧設計案) 軽量な初期分析 (Summarize)、全体像把握 (Overall Summary)、詳細レビュー (Review) の3段階で処理を進める想定でした。

```typescript
// 旧設計案のプロセッサメソッド
abstract summarize(...): Promise<Map<string, SummarizeResult>>;
protected abstract generateOverallSummary(...): Promise<OverallSummary | undefined>;
abstract review(...): Promise<IPullRequestProcessedResult>;
```

**現在の設計:** 現在のプロセッサインターフェース (`IPullRequestProcessor`) は、主に `process` メソッドを持ち、この中でレビュー処理全体（コンテキスト解釈、AI 呼び出し、結果生成）を行います。インタラクション用に `handleInteraction` メソッドも持ちます。3段階のような固定的なフェーズ分けはありません。

### 3.2 インクリメンタル処理 (旧設計案)

(旧設計案) バッチ処理 (`createHorizontalBatches`, `createVerticalBatches`) や結果の統合 (`mergeOverallSummaries`) による効率化を想定していました。

**現在の設計:** バッチ処理は、GitHub API 呼び出し (コメント投稿など) で有効ですが、旧設計案のような複雑な分析バッチは行いません。インクリメンタル処理（差分レビュー）は実装されていません。エラー処理は `Action Runner` とプロセッサの両方で必要です。

## 4. 拡張ポイント (旧設計案)

(旧設計案) プロセッサによるカスタム分析や将来的な拡張計画。

### 4.1 カスタム分析 (旧設計案)

(旧設計案) プロセッサが独自のアスペクト定義や分析ロジックを実装することを想定していました。

**現在の設計:** プロセッサは `IPullRequestProcessor` インターフェースを実装し、`process` メソッド内で自由に分析ロジックを実装できます。ただし、「アスペクト」のような Bot 共通の概念はありません。

### 4.2 将来の拡張計画 (旧設計案)

(旧設計案) コメントチェーン管理 (Bot 内部)、リソース最適化 (キャッシュ)、外部システム連携、履歴分析の強化などを検討していました。

**現在の設計との関連:**
-   **コメントチェーン管理:** GitHub の機能を利用する方針に変更。
-   **リソース最適化:** キャッシュよりも API 効率化やトークン管理が中心。
-   **外部システム連携:** GitHub Actions のエコシステムを活用。
-   **履歴分析:** Bot 自身での高度な分析は行わない方針。

## 5. 制限事項 (旧設計案)

(旧設計案) トークン制限や処理制約、その最適化について。

### 5.1 現在の制限 (旧設計案)

(旧設計案) トークン制限やバッチサイズ、並行処理数などの制約。

**現在の設計:** 同様の制約は存在し、プロセッサや `Action Runner` で考慮が必要です。

### 5.2 最適化のポイント (旧設計案)

(旧設計案) トークン使用の最適化、バッチ処理の調整、キャッシュ活用。

**現在の設計:** トークン最適化とバッチ処理は重要です。キャッシュは限定的な利用（設定ファイルのキャッシュなど）に留まる可能性があります。

## 6. 実装ガイドライン (旧設計案)

(旧設計案) 旧設計の `BaseProcessor` を継承したプロセッサの実装ガイドライン。

### 6.1 プロセッサーの実装 (旧設計案)

(旧設計案) `summarize`, `generateOverallSummary`, `review` メソッドの実装を要求していました。

```typescript
// 旧設計案のプロセッサ構造
class YourProcessor extends BaseProcessor {
  override async summarize(...) { }
  protected override async generateOverallSummary(...) { }
  override async review(...) { }
}
```

**現在の設計:** プロセッサは `IPullRequestProcessor` インターフェースを実装し、主に `process` と `handleInteraction` メソッドを実装します。`BaseProcessor` は存在するかもしれませんが、旧設計とは異なる責務を持つ可能性があります。

### 6.2 設定と調整 (旧設計案)

(旧設計案) パス設定 (`path_instructions`) やトークン設定 (`tokenConfig`)。

**現在の設計:** パス設定は `.coderabbitai.yaml` で行い、`Action Runner` が読み込みます。トークン設定はプロセッサ固有の設定や環境変数で管理される可能性があります。

---

(旧設計案の結論) この仕様書で定義されたコンテキスト管理システムにより、code-hedgehogは効率的で高品質なコードレビューを実現します。システムの各コンポーネントは明確な責務を持ち、拡張性と保守性を確保しながら、実用的なレビュー支援を提供します。

**現在の設計の結論:** 現在の Code Hedgehog は、GitHub Actions をベースとし、GitHub の標準機能を活用することで、よりシンプルで保守しやすく、GitHub エコシステムと親和性の高いアーキテクチャを目指しています。コンテキスト管理の複雑さの多くは GitHub プラットフォームと各プロセッサに委ねられます。