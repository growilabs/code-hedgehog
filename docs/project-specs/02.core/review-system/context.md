# レビューシステムの基本方針と非採用事項 (コンテキスト管理関連)

**重要:** このドキュメントは、Code Hedgehog の初期設計段階で検討された概念と、現在の設計方針および**採用していない事項**を明確化するものです。現在の設計では、GitHub Actions をベースとし、Bot (Action Runner) はプロセッサ (`IPullRequestProcessor`) に処理を委任します。多くのプロセッサは `BaseProcessor` を継承しており、その `process` メソッド内部では、`summarize` (ファイルごとの初期分析)、`generateOverallSummary` (PR全体の概要生成)、`review` (詳細なレビューコメント生成) という一連のステップが実行されます。しかし、これらのステップはプロセッサの内部実装であり、Bot (Action Runner) がこれらのステップを個別に管理・制御することはありません。

現在のコンテキスト収集・管理に関する具体的な仕様は、以下のドキュメントを参照してください。
-   [GitHub Bot 仕様](../../project-specs/05.github-bot/overview.md) (特にセクション 2.2 コンテキスト収集)
-   [GitHub Bot: コメント関連機能仕様](../../project-specs/05.github-bot/comment-chain-features.md)
-   [レビューコンテキスト管理の基本方針と非採用事項](./review-context.md) (Bot独自のコンテキストDB等に関する非採用事項)

---

## 1. 基本方針 (レビュープロセスとコンテキスト活用)

Code Hedgehog のレビュープロセスとコンテキスト活用における基本方針は以下の通りです。

-   **Bot からプロセッサへのシンプルな処理委任:** Bot (Action Runner) は、GitHub イベントをトリガーにコンテキスト（PR情報、ファイル差分、コメント履歴など）を収集・整形し、プロセッサ (`IPullRequestProcessor`) の `process` メソッドを呼び出します。インタラクションの場合は `handleInteraction` メソッドが呼び出されます。
-   **プロセッサ内部での段階的処理:** `BaseProcessor` を継承するプロセッサは、その `process` メソッド内で、一般的に以下のステップを順次実行します。
    1.  `summarize`: 個々のファイル変更に対して初期分析やトリアージを行います。
    2.  `generateOverallSummary`: `summarize` の結果を元に、プルリクエスト全体の変更に関する集約的な概要やテーマを生成します。
    3.  `review`: `summarize` および `generateOverallSummary` の結果を活用し、詳細なレビューコメントを生成します。
    これらのステップの具体的な実装（使用するAIモデル、プロンプト、内部的なバッチ処理など）は各プロセッサに委ねられます。
-   **Bot はプロセッサの内部ステップを管理しない:** Bot (Action Runner) はプロセッサの `process` メソッドを呼び出すのみで、その内部で `summarize`, `generateOverallSummary`, `review` がどのように実行されるか、あるいはこれらのメソッドが全て実行されるかについては関知しません。
-   **GitHub 機能の活用:** コメントスレッド、リッチな差分表示、Checks API など、GitHub の機能を最大限に活用し、Bot 独自の状態管理やUI提供は最小限に抑えます。

## 2. 現在の設計で採用していない事項 (Botの責務範囲および旧設計概念より)

過去の設計検討段階や、より複雑なシステムを想定した場合に議論された可能性のある事項のうち、現在の Code Hedgehog の **Bot (Action Runner) の責務としては採用していない**、または**システム全体として旧設計案のままでは採用していない**事項は以下の通りです。

-   **Bot レベルでのプロセッサ内部ステップの個別管理・制御:**
    -   Bot がプロセッサに対して、`summarize`、`generateOverallSummary`、`review` といったメソッドを個別に呼び出したり、これらのステップ間の遷移を管理したりすることはありません。
-   **Bot が主体となる「アスペクト」ベースのコンテキスト管理・分析指示:**
    -   Bot がレビューの「側面（アスペクト）」といった汎用的な共通概念を定義・管理し、それに基づいてプロセッサに特定の分析を指示するような仕組みは持ちません。「アスペクト」に類する概念は、プロセッサが内部的に情報を整理・活用する際に用いることはありますが、Bot がそれを横断的に管理するものではありません。
-   **Bot によるPR全体やファイルレベルの事前サマリー生成とプロセッサへの強制:**
    -   Bot がレビュー開始前に、PR全体やファイル単位での詳細なサマリーを独自に生成し、それをプロセッサに処理の前提として渡すようなことはありません。サマリー情報はプロセッサがその処理過程 (`summarize`, `generateOverallSummary`) で生成するものです。
-   **Bot 内部での汎用的な複雑な分析バッチ処理・結果統合ロジック:**
    -   旧設計案で検討されたような、Bot が主体となって分析処理を汎用的なバッチに分割し、その結果を統合するような複雑な処理フローは採用していません。プロセッサ（例: `OpenaiProcessor` の `generateOverallSummary`）が内部的に特定の処理でバッチ実行や結果のマージを行うことはありますが、これはプロセッサ固有の実装です。
-   **Bot 自身による高度な履歴分析・学習・リソース最適化:**
    -   Bot が過去のレビュー履歴を詳細に分析して自律的に学習したり、高度なキャッシュ戦略を駆使してリソースを最適化したりする機能は、現在の設計では限定的です。履歴情報はプロセッサに渡され、プロセッサがそれを活用することはありますが、Bot 自身が複雑な分析・最適化を行う主体とはなりません。

これらの「採用していない事項」を明確にすることで、現在の Code Hedgehog のアーキテクチャにおける Bot (Action Runner) とプロセッサの役割分担、プロセッサ内部処理の自律性、そして GitHub プラットフォームへの依存関係をより正確に理解することができます。
